name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Install syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload archives for PyPI job
        uses: actions/upload-artifact@v4
        with:
          name: goreleaser-archives
          path: dist/ancla_*
          retention-days: 1

  pypi-wheels:
    needs: goreleaser
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            plat: manylinux_2_17_x86_64.manylinux2014_x86_64
          - goos: linux
            goarch: arm64
            plat: manylinux_2_17_aarch64.manylinux2014_aarch64
          - goos: darwin
            goarch: amd64
            plat: macosx_10_9_x86_64
          - goos: darwin
            goarch: arm64
            plat: macosx_11_0_arm64
          - goos: windows
            goarch: amd64
            plat: win_amd64
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: goreleaser-archives
          path: dist/

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build wheel
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          PLAT="${{ matrix.plat }}"
          ARCHIVE_PREFIX="ancla_${VERSION}_${{ matrix.goos }}_${{ matrix.goarch }}"

          mkdir -p staging dist_wheels

          # Extract the platform binary
          if [ "${{ matrix.goos }}" = "windows" ]; then
            ARCHIVE=$(ls dist/${ARCHIVE_PREFIX}.zip 2>/dev/null | head -1)
            unzip -o "$ARCHIVE" -d staging/
            BIN_NAME="ancla.exe"
          else
            ARCHIVE=$(ls dist/${ARCHIVE_PREFIX}.tar.gz 2>/dev/null | head -1)
            tar xzf "$ARCHIVE" -C staging/ --strip-components=0 2>/dev/null || tar xzf "$ARCHIVE" -C staging/
            BIN_NAME="ancla"
          fi

          chmod +x "staging/${BIN_NAME}" 2>/dev/null || true

          # Assemble wheel structure
          DIST_INFO="ancla-${VERSION}.dist-info"
          DATA_DIR="ancla-${VERSION}.data/scripts"
          WHEEL_DIR="wheel_build"
          mkdir -p "${WHEEL_DIR}/${DATA_DIR}" "${WHEEL_DIR}/${DIST_INFO}"

          cp "staging/${BIN_NAME}" "${WHEEL_DIR}/${DATA_DIR}/"

          # PEP 566 metadata
          cat > "${WHEEL_DIR}/${DIST_INFO}/METADATA" <<METAEOF
          Metadata-Version: 2.1
          Name: ancla
          Version: ${VERSION}
          Summary: CLI client for the Ancla deployment platform
          Author-email: SideQuest Labs <engineering@sidequestlabs.dev>
          Home-page: https://github.com/SideQuest-Group/ancla-client
          Project-URL: Documentation, https://docs.ancla.dev
          Project-URL: Source, https://github.com/SideQuest-Group/ancla-client
          Project-URL: Issues, https://github.com/SideQuest-Group/ancla-client/issues
          License: Apache-2.0
          Requires-Python: >=3.9
          Classifier: Development Status :: 4 - Beta
          Classifier: Environment :: Console
          Classifier: Intended Audience :: Developers
          Classifier: Intended Audience :: System Administrators
          Classifier: License :: OSI Approved :: Apache Software License
          Classifier: Operating System :: OS Independent
          Classifier: Programming Language :: Other
          Classifier: Topic :: System :: Systems Administration
          Description-Content-Type: text/markdown

          # Ancla CLI

          Command-line client for the [Ancla](https://ancla.dev) deployment platform.

          ## Install

          \`\`\`bash
          pip install ancla
          \`\`\`

          Full documentation: https://docs.ancla.dev
          METAEOF

          # PEP 427 wheel metadata
          cat > "${WHEEL_DIR}/${DIST_INFO}/WHEEL" <<WHEELEOF
          Wheel-Version: 1.0
          Generator: ancla-release
          Root-Is-Purelib: false
          Tag: py3-none-${PLAT}
          WHEELEOF

          # top_level.txt (no Python packages â€” binary-only wheel)
          touch "${WHEEL_DIR}/${DIST_INFO}/top_level.txt"

          # PEP 376 RECORD with sha256 digests
          cd "${WHEEL_DIR}"
          : > "${DIST_INFO}/RECORD"
          for f in $(find . -type f ! -path "./${DIST_INFO}/RECORD"); do
            REL="${f#./}"
            HASH=$(python3 -c "
          import hashlib, base64
          with open('${REL}', 'rb') as fh:
              digest = hashlib.sha256(fh.read()).digest()
          print('sha256=' + base64.urlsafe_b64encode(digest).rstrip(b'=').decode())
          ")
            SIZE=$(wc -c < "${REL}" | tr -d ' ')
            echo "${REL},${HASH},${SIZE}" >> "${DIST_INFO}/RECORD"
          done
          echo "${DIST_INFO}/RECORD,," >> "${DIST_INFO}/RECORD"

          # Pack wheel
          WHEEL_NAME="ancla-${VERSION}-py3-none-${PLAT}.whl"
          zip -r "../dist_wheels/${WHEEL_NAME}" .
          cd ..

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist_wheels/*.whl
          retention-days: 1

  publish-pypi:
    needs: pypi-wheels
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheel-*
          path: dist/
          merge-multiple: true

      - name: Generate SHA256 checksums for wheels
        run: |
          cd dist
          sha256sum *.whl | tee ../wheel-checksums-sha256.txt

      - name: Generate GitHub artifact attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: "dist/*.whl"

      - name: Upload wheels and checksums to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ github.ref_name }}" \
            dist/*.whl \
            wheel-checksums-sha256.txt \
            --repo "${{ github.repository }}" \
            --clobber

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          attestations: true

  publish-npm:
    needs: goreleaser
    runs-on: ubuntu-latest
    environment: npm
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Upgrade npm for trusted publishing (requires >=11.5.1)
        run: npm install -g npm@latest && npm --version

      - uses: actions/download-artifact@v4
        with:
          name: goreleaser-archives
          path: dist/

      - name: Stage platform binaries and publish
        run: |
          VERSION="${GITHUB_REF_NAME#v}"

          # Map: npm-pkg-dir goos goarch binary-name
          declare -A PKG_MAP=(
            ["ancla-linux-x64"]="linux amd64 ancla"
            ["ancla-linux-arm64"]="linux arm64 ancla"
            ["ancla-darwin-x64"]="darwin amd64 ancla"
            ["ancla-darwin-arm64"]="darwin arm64 ancla"
            ["ancla-win32-x64"]="windows amd64 ancla.exe"
          )

          for pkg in "${!PKG_MAP[@]}"; do
            read -r goos goarch binname <<< "${PKG_MAP[$pkg]}"
            ARCHIVE_PREFIX="ancla_${VERSION}_${goos}_${goarch}"

            mkdir -p "npm/${pkg}/bin"

            if [ "$goos" = "windows" ]; then
              ARCHIVE=$(ls dist/${ARCHIVE_PREFIX}.zip 2>/dev/null | head -1)
              unzip -o "$ARCHIVE" -d "npm/${pkg}/bin/"
            else
              ARCHIVE=$(ls dist/${ARCHIVE_PREFIX}.tar.gz 2>/dev/null | head -1)
              tar xzf "$ARCHIVE" -C "npm/${pkg}/bin/" --strip-components=0 2>/dev/null || tar xzf "$ARCHIVE" -C "npm/${pkg}/bin/"
            fi

            chmod +x "npm/${pkg}/bin/${binname}" 2>/dev/null || true

            # Set version in platform package
            cd "npm/${pkg}"
            npm version "${VERSION}" --no-git-tag-version --allow-same-version
            npm publish --access public --provenance
            cd ../..
          done

          # Publish the meta-package last
          cd npm/ancla

          # Update optionalDependencies versions
          node -e "
            const pkg = require('./package.json');
            pkg.version = '${VERSION}';
            for (const dep of Object.keys(pkg.optionalDependencies)) {
              pkg.optionalDependencies[dep] = '${VERSION}';
            }
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          npm publish --access public --provenance
